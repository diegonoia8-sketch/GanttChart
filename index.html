<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestión de Proyectos (Local)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.1.1/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
            color: #1f2937;
        }
        .container-main {
            display: flex;
            height: 100vh;
            overflow: hidden;
        }
        .sidebar {
            width: 320px;
            background-color: #ffffff;
            padding: 2.5rem 2rem;
            border-right: 1px solid #e5e7eb;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
            display: flex;
            flex-direction: column;
            gap: 2rem;
        }
        .main-content {
            flex-grow: 1;
            padding: 2rem;
            display: flex;
            flex-direction: column;
            gap: 2rem;
            overflow: auto;
        }
        .card {
            background-color: #ffffff;
            border-radius: 1.5rem;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.08);
            padding: 2rem;
        }
        .task-row:hover {
            background-color: #f9fafb;
        }
        .gantt-bar {
            height: 24px;
            border-radius: 9999px;
            background: linear-gradient(90deg, #3b82f6, #1d4ed8);
            transition: transform 0.2s ease-in-out;
            cursor: pointer;
        }
        .gantt-bar:hover {
            transform: scale(1.05);
        }
        .gantt-table-container {
            overflow-x: auto;
            position: relative;
            background-color: white;
            border-radius: 1.5rem;
            box-shadow: 0 4px 10px rgba(0,0,0,0.05);
        }
        th, td {
            padding: 12px;
            border-bottom: 1px solid #e5e7eb;
            white-space: nowrap;
        }
        thead th {
            position: sticky;
            top: 0;
            background-color: #e5e7eb;
            z-index: 10;
        }
        .task-detail-cell {
            min-width: 180px;
        }
        .delete-btn {
            background-color: #ef4444;
            transition: background-color 0.2s, transform 0.2s;
            box-shadow: 0 4px 6px rgba(239, 68, 68, 0.2);
        }
        .delete-btn:hover {
            background-color: #dc2626;
            transform: translateY(-1px);
        }
        .add-task-row input, .add-task-row select {
            border: 1px solid #d1d5db;
            padding: 6px;
            border-radius: 0.5rem;
            width: 100%;
            transition: box-shadow 0.2s;
        }
        .add-task-row input:focus, .add-task-row select:focus {
            outline: none;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.25);
        }
        .editable {
            cursor: pointer;
            position: relative;
        }
        .editable input, .editable select {
            background: none;
            border: 1px solid #d1d5db;
            padding: 4px;
            border-radius: 0.5rem;
            width: 100%;
            color: #1f2937;
        }
        .pdf-exporting .add-task-row,
        .pdf-exporting .delete-btn,
        .pdf-exporting .btn-with-icon {
            display: none !important;
        }
        #loadingSpinner {
            border: 4px solid #f3f4f6;
            border-top: 4px solid #3b82f6;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-gray-100 antialiased">
    <div class="container-main">
        <div class="sidebar">
            <h1 class="text-3xl font-extrabold text-gray-900 mb-4">Gestión de Proyectos</h1>
            <p class="text-xs text-gray-500 mb-2">Almacenamiento: <span id="userIdDisplay" class="font-mono text-gray-700">Local</span></p>

            <div class="card p-6 bg-gray-50">
                <h2 class="text-xl font-bold text-gray-700 mb-4">Crear Proyecto</h2>
                <div class="flex flex-col gap-4">
                    <input type="text" id="newProjectNameInput" placeholder="Nombre del proyecto" class="p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 shadow-sm bg-white text-gray-900 placeholder-gray-500">
                    <button id="createProjectBtn" class="bg-blue-600 text-white p-3 rounded-lg font-semibold hover:bg-blue-700 transition duration-300 btn-with-icon shadow-md">
                        <i class="fas fa-plus mr-2"></i> Crear Proyecto
                    </button>
                </div>
            </div>

            <div class="card p-6 bg-gray-50">
                <h2 class="text-xl font-bold text-gray-700 mb-4">Seleccionar Proyecto</h2>
                <div class="flex flex-col gap-2">
                    <select id="projectSelect" class="p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 shadow-sm bg-white text-gray-900">
                        <option value="">-- Seleccione un proyecto --</option>
                    </select>
                    <div id="loadingProjects" class="flex items-center gap-2 text-sm text-gray-500 hidden">
                        <div id="loadingSpinner"></div>
                        <span>Cargando proyectos...</span>
                    </div>
                </div>
            </div>
        </div>

        <div class="main-content" id="mainContent">
            <div id="projectContentContainer" class="flex flex-col gap-8 hidden">
                <div id="tasksHeader" class="flex justify-between items-center mb-6">
                    <h2 class="text-2xl font-bold text-gray-800">Tareas del Proyecto: <span id="currentProjectName" class="text-blue-600"></span></h2>
                    <button id="exportPdfBtn" class="bg-red-600 text-white p-3 rounded-lg font-semibold hover:bg-red-700 transition duration-300 btn-with-icon shadow-md">
                        <i class="fas fa-file-pdf mr-2"></i> Exportar a PDF
                    </button>
                </div>

                <div id="ganttContainer" class="gantt-table-container rounded-xl flex-grow">
                    <table class="w-full border-collapse">
                        <thead>
                            <tr class="bg-gray-100 text-gray-900 font-bold text-sm uppercase sticky top-0 z-10">
                                <th class="task-detail-cell text-left">Nombre</th>
                                <th class="task-detail-cell text-left">Responsable</th>
                                <th class="task-detail-cell text-left">Predecesora</th>
                                <th class="task-detail-cell text-left">Duración</th>
                                <th class="task-detail-cell text-left">Inicio</th>
                                <th class="task-detail-cell text-left">Fin</th>
                                <th class="task-detail-cell text-left">Acciones</th>
                                <th colspan="100" class="text-center">Diagrama de Gantt</th>
                            </tr>
                            <tr id="ganttDatesHeader" class="bg-gray-200 text-gray-800 font-medium sticky top-[48px] z-10">
                                <th colspan="7"></th>
                            </tr>
                        </thead>
                        <tbody id="ganttBody">
                            <tr class="bg-gray-50 add-task-row">
                                <td class="p-3"><input type="text" id="newTaskInput" placeholder="Nombre de la tarea" class="w-full rounded-md border border-gray-300 p-2 text-gray-900 focus:outline-none focus:ring-2 focus:ring-blue-500 shadow-sm"></td>
                                <td class="p-3"><input type="text" id="newResponsibleInput" placeholder="Responsable" class="w-full rounded-md border border-gray-300 p-2 text-gray-900 focus:outline-none focus:ring-2 focus:ring-blue-500 shadow-sm"></td>
                                <td class="p-3"><select id="predecessorSelect" class="w-full rounded-md border border-gray-300 p-2 text-gray-900 focus:outline-none focus:ring-2 focus:ring-blue-500 shadow-sm"><option value="">Predecesora (opcional)</option></select></td>
                                <td class="p-3"><input type="number" id="newDurationInput" placeholder="Duración (días)" class="w-full rounded-md border border-gray-300 p-2 text-gray-900 focus:outline-none focus:ring-2 focus:ring-blue-500 shadow-sm"></td>
                                <td class="p-3"><input type="date" id="newStartDateInput" class="w-full rounded-md border border-gray-300 p-2 text-gray-900 focus:outline-none focus:ring-2 focus:ring-blue-500 shadow-sm"></td>
                                <td></td>
                                <td class="p-3">
                                    <button id="addTaskBtn" class="bg-blue-600 text-white p-2 rounded-lg font-semibold hover:bg-blue-700 transition duration-300 btn-with-icon w-full shadow-md text-sm">
                                        <i class="fas fa-plus mr-1"></i> Añadir
                                    </button>
                                </td>
                                <td colspan="100"></td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <div id="messageBox" class="hidden fixed inset-0 bg-gray-900 bg-opacity-70 flex items-center justify-center p-4 z-50">
            <div class="bg-white text-gray-900 p-8 rounded-xl shadow-2xl text-center max-w-sm">
                <p id="messageText" class="text-lg font-medium mb-4"></p>
                <button id="closeMessageBtn" class="bg-blue-600 text-white px-6 py-2 rounded-full hover:bg-blue-700 transition shadow-md">Aceptar</button>
            </div>
        </div>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script>
        // Variables globales
        let currentProjectId = null;
        let allTasks = [];
        let allProjects = [];

        // Referencias de elementos DOM
        const newProjectNameInput = document.getElementById('newProjectNameInput');
        const createProjectBtn = document.getElementById('createProjectBtn');
        const projectSelect = document.getElementById('projectSelect');
        const loadingProjects = document.getElementById('loadingProjects');
        const currentProjectName = document.getElementById('currentProjectName');
        const exportPdfBtn = document.getElementById('exportPdfBtn');
        const messageBox = document.getElementById('messageBox');
        const messageText = document.getElementById('messageText');
        const closeMessageBtn = document.getElementById('closeMessageBtn');
        const projectContentContainer = document.getElementById('projectContentContainer');
        const predecessorSelect = document.getElementById('predecessorSelect');

        // --- Almacenamiento Local (localStorage) ---

        /** Obtiene todos los proyectos de localStorage. */
        function getProjects() {
            try {
                const projects = localStorage.getItem('localProjects');
                return projects ? JSON.parse(projects) : [];
            } catch (e) {
                console.error("Error reading projects from localStorage:", e);
                return [];
            }
        }

        /** Guarda todos los proyectos en localStorage. */
        function saveProjects(projects) {
            try {
                localStorage.setItem('localProjects', JSON.stringify(projects));
                allProjects = projects; // Actualiza la variable global
            } catch (e) {
                console.error("Error saving projects to localStorage:", e);
                showMessage("Error al guardar proyectos. El almacenamiento local podría estar lleno.");
            }
        }

        /** Obtiene las tareas de un proyecto específico de localStorage. */
        function getTasks(projectId) {
            try {
                const tasks = localStorage.getItem(`tasks_${projectId}`);
                return tasks ? JSON.parse(tasks) : [];
            } catch (e) {
                console.error("Error reading tasks from localStorage:", e);
                return [];
            }
        }

        /** Guarda las tareas de un proyecto específico en localStorage. */
        function saveTasks(projectId, tasks) {
            try {
                localStorage.setItem(`tasks_${projectId}`, JSON.stringify(tasks));
                allTasks = tasks; // Actualiza la variable global
                renderGanttTable(allTasks); // Vuelve a renderizar después de guardar
            } catch (e) {
                console.error("Error saving tasks to localStorage:", e);
                showMessage("Error al guardar tareas. El almacenamiento local podría estar lleno.");
            }
        }

        // --- Lógica de la Aplicación ---

        /** Simula el listener de proyectos de Firebase. */
        function setupProjectListener() {
            loadingProjects.classList.remove('hidden');
            allProjects = getProjects();
            
            projectSelect.innerHTML = '<option value="">-- Seleccione un proyecto --</option>';
            allProjects.forEach(project => {
                const option = document.createElement('option');
                option.value = project.id;
                option.textContent = project.name;
                projectSelect.appendChild(option);
            });
            
            if (currentProjectId) {
                projectSelect.value = currentProjectId;
                projectSelect.dispatchEvent(new Event('change'));
            }

            loadingProjects.classList.add('hidden');
        }

        /** Simula el listener de tareas para el proyecto seleccionado. */
        function setupTasksListener() {
            if (!currentProjectId) {
                allTasks = [];
                renderGanttTable(allTasks);
                return;
            }
            // Obtener y renderizar tareas directamente
            allTasks = getTasks(currentProjectId);
            renderGanttTable(allTasks);
        }

        /** Calcula la semana del año (ISO 8601). */
        function getWeekNumber(d) {
            d = new Date(Date.UTC(d.getFullYear(), d.getMonth(), d.getDate()));
            d.setUTCDate(d.getUTCDate() + 4 - (d.getUTCDay() || 7));
            const yearStart = new Date(Date.UTC(d.getUTCFullYear(), 0, 1));
            return Math.ceil((((d - yearStart) / 86400000) + 1) / 7);
        }

        /** Renderiza el diagrama de Gantt en formato de tabla. */
        function renderGanttTable(tasks) {
            const ganttDatesHeader = document.getElementById('ganttDatesHeader');
            const ganttBody = document.getElementById('ganttBody');
            
            // Limpiar solo las filas de tareas (mantener la fila de entrada).
            while (ganttBody.rows.length > 1) {
                ganttBody.deleteRow(1);
            }
            
            // Llenar las opciones del desplegable de predecesoras
            predecessorSelect.innerHTML = '<option value="">Predecesora (opcional)</option>';
            tasks.forEach(task => {
                const option = document.createElement('option');
                option.value = task.id;
                option.textContent = task.name;
                predecessorSelect.appendChild(option);
            });

            if (tasks.length === 0) {
                ganttDatesHeader.innerHTML = '';
                const weekHeaderCell = document.createElement('th');
                weekHeaderCell.colSpan = "7";
                ganttDatesHeader.appendChild(weekHeaderCell);
                return;
            }

            // Ordenar tareas por fecha de inicio
            tasks.sort((a, b) => {
                const dateA = a.startDate ? new Date(a.startDate) : new Date(0);
                const dateB = b.startDate ? new Date(b.startDate) : new Date(0);
                return dateA - dateB;
            });

            // Determinar el rango de fechas para el Gantt
            const allDates = new Set();
            tasks.forEach(task => {
                if (task.startDate && task.duration) {
                    const startDate = new Date(task.startDate);
                    for (let i = 0; i < task.duration; i++) {
                        const date = new Date(startDate);
                        date.setDate(startDate.getDate() + i);
                        allDates.add(date.toISOString().slice(0, 10));
                    }
                }
            });

            const sortedDates = Array.from(allDates).sort();
            const minDate = sortedDates.length > 0 ? new Date(sortedDates[0]) : new Date();
            const maxDate = new Date(Math.max(...tasks.map(t => new Date(t.endDate).getTime() || 0)));

            // Renderizar encabezados de semanas
            ganttDatesHeader.innerHTML = '';
            const weekHeaderCell = document.createElement('th');
            weekHeaderCell.colSpan = "7";
            ganttDatesHeader.appendChild(weekHeaderCell);

            let currentDate = new Date(minDate);
            currentDate.setDate(currentDate.getDate() - (currentDate.getDay() || 7) + 1); // Empezar en Lunes
            
            const weekCount = Math.ceil((maxDate.getTime() - currentDate.getTime()) / (1000 * 60 * 60 * 24 * 7)) + 1;
            for (let i = 0; i < weekCount; i++) {
                const weekNumber = getWeekNumber(currentDate);
                const th = document.createElement('th');
                th.textContent = `Sem ${weekNumber}`;
                th.className = "text-center p-3 border-b-2 border-gray-300";
                ganttDatesHeader.appendChild(th);
                currentDate.setDate(currentDate.getDate() + 7);
            }

            // Renderizar filas de tareas
            tasks.forEach(task => {
                const row = document.createElement('tr');
                row.className = 'task-row bg-white text-gray-900';
                row.setAttribute('data-task-id', task.id);

                // Celdas de detalles de tarea
                const nameCell = createEditableCell(task.name, 'name', task.id);
                row.appendChild(nameCell);

                const responsibleCell = createEditableCell(task.responsible, 'responsible', task.id);
                row.appendChild(responsibleCell);
                
                const predecessorName = task.predecessorId ? (tasks.find(t => t.id === task.predecessorId)?.name || 'N/A') : 'N/A';
                const predecessorCell = createEditableCell(predecessorName, 'predecessorId', task.id, task.predecessorId);
                row.appendChild(predecessorCell);
                
                const durationCell = createEditableCell(`${task.duration} días`, 'duration', task.id);
                row.appendChild(durationCell);

                const startDateCell = createEditableCell(task.startDate, 'startDate', task.id);
                row.appendChild(startDateCell);
                
                const endDateCell = document.createElement('td');
                endDateCell.textContent = task.endDate;
                endDateCell.className = "task-detail-cell";
                row.appendChild(endDateCell);
                
                // Celda del botón de eliminar
                const deleteCell = document.createElement('td');
                const deleteBtn = document.createElement('button');
                deleteBtn.className = 'delete-btn text-white px-3 py-1 rounded-full text-sm font-semibold';
                deleteBtn.innerHTML = '<i class="fas fa-trash-alt"></i>';
                deleteBtn.addEventListener('click', () => {
                    deleteTask(task.id);
                });
                deleteCell.appendChild(deleteBtn);
                row.appendChild(deleteCell);
                
                // Celdas del diagrama de Gantt
                for (let i = 0; i < weekCount; i++) {
                    const ganttCell = document.createElement('td');
                    ganttCell.className = 'relative text-center';

                    const weekStart = new Date(minDate);
                    weekStart.setDate(weekStart.getDate() - (weekStart.getDay() || 7) + 1 + i * 7);
                    const weekEnd = new Date(weekStart);
                    weekEnd.setDate(weekEnd.getDate() + 6);

                    const taskStartDate = new Date(task.startDate);
                    const taskEndDate = new Date(task.endDate);

                    if (taskStartDate <= weekEnd && taskEndDate >= weekStart) {
                        const bar = document.createElement('div');
                        bar.className = 'gantt-bar mx-1';
                        bar.setAttribute('data-task-id', task.id);
                        bar.setAttribute('data-bar-type', 'main');

                        const startOffsetDays = Math.max(0, (taskStartDate - weekStart) / (1000 * 60 * 60 * 24));
                        const endOffsetDays = Math.min(6, (taskEndDate - weekStart) / (1000 * 60 * 60 * 24));
                        const barWidth = (endOffsetDays - startOffsetDays + 1) / 7 * 100;
                        const barLeft = (startOffsetDays / 7) * 100;

                        bar.style.width = `${barWidth}%`;
                        bar.style.marginLeft = `${barLeft}%`;
                        bar.style.position = 'absolute';
                        bar.style.left = '0';
                        bar.style.top = '50%';
                        bar.style.transform = 'translateY(-50%)';

                        ganttCell.appendChild(bar);
                    }
                    row.appendChild(ganttCell);
                }
                
                ganttBody.appendChild(row);
            });
        }

        /** Crea una celda de tabla editable. */
        function createEditableCell(text, field, taskId, predecessorId = null) {
            const cell = document.createElement('td');
            cell.textContent = text;
            cell.className = "task-detail-cell editable";
            cell.setAttribute('data-field', field);
            if (predecessorId !== null) {
                cell.setAttribute('data-predecessor-id', predecessorId);
            }
            return cell;
        }
        
        // --- Funciones de Modificación de Datos ---

        /** Crea un nuevo proyecto y lo guarda localmente. */
        function createProject(projectName) {
            const newProject = {
                id: Date.now().toString(), // ID simple basado en el tiempo
                name: projectName,
                createdAt: new Date().toISOString()
            };
            
            const projects = getProjects();
            projects.push(newProject);
            saveProjects(projects);
            currentProjectId = newProject.id;
            
            // Lógica para actualizar el selector de proyectos
            setupProjectListener(); // Recargar el selector
            projectSelect.value = currentProjectId;
            projectSelect.dispatchEvent(new Event('change'));

            showMessage('Proyecto creado con éxito.');
        }

        /** Agrega una nueva tarea y la guarda localmente. */
        function addTaskToFirestore(name, responsible, duration, predecessorId, userStartDate) {
            if (!currentProjectId) {
                showMessage("Por favor, seleccione un proyecto primero.");
                return;
            }

            let startDate = userStartDate;
            const durationInt = parseInt(duration);

            // 1. Calcular la fecha de inicio (si no se proporciona)
            if (!startDate && predecessorId) {
                const predecessorTask = allTasks.find(t => t.id === predecessorId);
                if (predecessorTask) {
                    const predecessorEndDate = new Date(predecessorTask.endDate);
                    predecessorEndDate.setDate(predecessorEndDate.getDate() + 1);
                    startDate = predecessorEndDate.toISOString().slice(0, 10);
                }
            }
            
            if (!startDate) {
                startDate = new Date().toISOString().slice(0, 10);
            }
            
            // 2. Calcular la fecha de fin
            const endDate = new Date(startDate);
            endDate.setDate(endDate.getDate() + durationInt - 1);

            // 3. Crear el objeto de tarea
            const newTask = {
                id: Date.now().toString() + Math.random().toString(16).slice(2), // ID único
                name,
                responsible,
                duration: durationInt,
                startDate,
                endDate: endDate.toISOString().slice(0, 10),
                createdAt: new Date().toISOString()
            };
            if (predecessorId) {
                newTask.predecessorId = predecessorId;
            }
            
            // 4. Guardar en localStorage
            const tasks = getTasks(currentProjectId);
            tasks.push(newTask);
            saveTasks(currentProjectId, tasks);

            showMessage('Tarea agregada con éxito.');
        }

        /** Actualiza una tarea y la guarda localmente. */
        function updateTaskInFirestore(taskId, field, value) {
            if (!currentProjectId) return;

            const tasks = getTasks(currentProjectId);
            const taskIndex = tasks.findIndex(t => t.id === taskId);
            if (taskIndex === -1) return;

            const existingTask = tasks[taskIndex];
            
            let newStartDate = existingTask.startDate;
            let newDuration = existingTask.duration;
            let newPredecessorId = existingTask.predecessorId;
            
            // 1. Aplicar el cambio del campo
            if (field === 'startDate') {
                newStartDate = value;
                existingTask.startDate = newStartDate;
                existingTask.predecessorId = undefined; // Borrar predecesora si se establece manualmente el inicio
            } else if (field === 'duration') {
                newDuration = parseInt(value);
                existingTask.duration = newDuration;
            } else if (field === 'responsible' || field === 'name') {
                existingTask[field] = value;
            } else if (field === 'predecessorId') {
                newPredecessorId = value;
                if (newPredecessorId) {
                    const predecessorTask = allTasks.find(t => t.id === newPredecessorId);
                    if (predecessorTask) {
                        const predecessorEndDate = new Date(predecessorTask.endDate);
                        predecessorEndDate.setDate(predecessorEndDate.getDate() + 1);
                        newStartDate = predecessorEndDate.toISOString().slice(0, 10);
                        existingTask.startDate = newStartDate;
                    }
                } else {
                    // Si se elimina la predecesora, usar la fecha de hoy o la fecha de inicio existente
                    newStartDate = existingTask.startDate || new Date().toISOString().slice(0, 10);
                    existingTask.startDate = newStartDate;
                }
                existingTask.predecessorId = newPredecessorId;
            }

            // 2. Recalcular la fecha de fin si es necesario
            if (field === 'startDate' || field === 'duration' || field === 'predecessorId') {
                const newEndDate = new Date(newStartDate);
                newEndDate.setDate(newEndDate.getDate() + newDuration - 1);
                existingTask.endDate = newEndDate.toISOString().slice(0, 10);
            }
            
            tasks[taskIndex] = existingTask;
            saveTasks(currentProjectId, tasks);
            showMessage('Tarea actualizada con éxito.');
        }

        /** Elimina una tarea y la guarda localmente. */
        function deleteTask(taskId) {
            if (!currentProjectId) return;

            const tasks = getTasks(currentProjectId);
            const updatedTasks = tasks.filter(t => t.id !== taskId);
            
            saveTasks(currentProjectId, updatedTasks);
            showMessage('Tarea eliminada con éxito.');
        }

        // --- Manejadores de Eventos ---

        function handleAddTask() {
            const newTaskInput = document.getElementById('newTaskInput');
            const newResponsibleInput = document.getElementById('newResponsibleInput');
            const newDurationInput = document.getElementById('newDurationInput');
            const newStartDateInput = document.getElementById('newStartDateInput');
            
            const taskName = newTaskInput.value.trim();
            const responsible = newResponsibleInput.value.trim();
            const duration = newDurationInput.value;
            const startDate = newStartDateInput.value;
            const predecessorId = predecessorSelect.value;

            if (taskName === '' || responsible === '' || duration === '' || parseInt(duration) <= 0) {
                showMessage('Por favor, completa todos los campos: nombre de tarea, responsable y una duración válida.');
                return;
            }
            addTaskToFirestore(taskName, responsible, duration, predecessorId, startDate);
            newTaskInput.value = '';
            newResponsibleInput.value = '';
            newDurationInput.value = '';
            newStartDateInput.value = '';
            predecessorSelect.value = '';
        }

        function handleExportPdf() {
            const element = document.querySelector('.gantt-table-container table');

            if (!element || allTasks.length === 0) {
                showMessage("No hay tareas ni un diagrama de Gantt para exportar.");
                return;
            }
            showMessage("Generando PDF... por favor espere.");
            
            const body = document.body;
            body.classList.add('pdf-exporting');

            const ganttTableContainer = document.querySelector('.gantt-table-container');
            const originalScrollLeft = ganttTableContainer.scrollLeft;

            // Ajustes para html2canvas para capturar todo el ancho
            ganttTableContainer.style.overflowX = 'visible';
            const originalWidth = ganttTableContainer.style.width;
            ganttTableContainer.style.width = `${element.offsetWidth}px`;
            
            setTimeout(() => {
                html2canvas(element, { 
                    scale: 2, 
                    logging: true,
                    useCORS: true,
                    backgroundColor: null,
                    boxShadow: 'none'
                }).then(canvas => {
                    const imgData = canvas.toDataURL('image/jpeg', 1.0);
                    const { jsPDF } = window.jspdf;
                    
                    const pdf = new jsPDF({
                        orientation: 'landscape',
                        unit: 'mm',
                        format: 'a4'
                    });

                    const imgWidth = canvas.width;
                    const imgHeight = canvas.height;
                    const pdfWidth = pdf.internal.pageSize.getWidth();
                    const pdfHeight = pdf.internal.pageSize.getHeight();

                    const ratio = Math.min(pdfWidth / imgWidth, pdfHeight / imgHeight);
                    const scaledWidth = imgWidth * ratio;
                    const scaledHeight = imgHeight * ratio;

                    const x = (pdfWidth - scaledWidth) / 2;
                    const y = 10;
                    
                    pdf.addImage(imgData, 'JPEG', x, y, scaledWidth, scaledHeight);
                    pdf.save(`Diagrama_Gantt_${currentProjectName.textContent}_${new Date().toISOString().slice(0, 10)}.pdf`);
                    showMessage("¡Tu diagrama se ha exportado con éxito a PDF!");
                    
                }).catch(error => {
                    console.error("Error al generar el PDF:", error);
                    showMessage("Error al generar el PDF. Inténtalo de nuevo.");
                }).finally(() => {
                    // Restaurar estilos
                    ganttTableContainer.style.overflowX = 'auto';
                    ganttTableContainer.style.width = originalWidth; // Restaurar el ancho original
                    ganttTableContainer.scrollLeft = originalScrollLeft;
                    body.classList.remove('pdf-exporting');
                });
            }, 100);
        }

        // --- Inicialización y Escucha de Eventos DOM ---

        document.addEventListener('DOMContentLoaded', () => {
            // Inicializar la carga de proyectos locales al cargar la página
            setupProjectListener();
        });

        createProjectBtn.addEventListener('click', () => {
            const projectName = newProjectNameInput.value.trim();
            if (projectName === '') {
                showMessage("Por favor, ingrese un nombre para el proyecto.");
                return;
            }
            createProject(projectName);
            newProjectNameInput.value = '';
        });

        projectSelect.addEventListener('change', (e) => {
            currentProjectId = e.target.value;
            if (currentProjectId) {
                const selectedProjectName = e.target.options[e.target.selectedIndex].textContent;
                currentProjectName.textContent = selectedProjectName;
                projectContentContainer.classList.remove('hidden'); 
                setupTasksListener();
            } else {
                currentProjectName.textContent = '';
                projectContentContainer.classList.add('hidden');
                setupTasksListener(); // Limpia la vista de tareas
            }
        });

        document.getElementById('addTaskBtn').addEventListener('click', handleAddTask);

        predecessorSelect.addEventListener('change', (e) => {
            const predecessorId = e.target.value;
            if (predecessorId) {
                const predecessorTask = allTasks.find(t => t.id === predecessorId);
                if (predecessorTask) {
                    const predecessorEndDate = new Date(predecessorTask.endDate);
                    predecessorEndDate.setDate(predecessorEndDate.getDate() + 1);
                    document.getElementById('newStartDateInput').value = predecessorEndDate.toISOString().slice(0, 10);
                }
            } else {
                document.getElementById('newStartDateInput').value = '';
            }
        });

        exportPdfBtn.addEventListener('click', handleExportPdf);

        // Manejo de la edición en línea
        document.addEventListener('click', function(e) {
            const editableCell = e.target.closest('.editable');
            if (editableCell && !editableCell.querySelector('input, select')) {
                const originalText = editableCell.textContent.trim();
                const field = editableCell.dataset.field;
                const taskId = editableCell.closest('tr').dataset.taskId;
                
                editableCell.innerHTML = '';
                
                if (field === 'startDate') {
                    const input = document.createElement('input');
                    input.type = 'date';
                    input.value = originalText;
                    input.className = 'w-full text-gray-900';
                    editableCell.appendChild(input);
                    input.focus();
                    
                    input.addEventListener('change', function() {
                        updateTaskInFirestore(taskId, field, input.value);
                    });
                    input.addEventListener('blur', function() {
                        editableCell.textContent = originalText;
                    });
                } else if (field === 'predecessorId') {
                    const select = document.createElement('select');
                    const options = allTasks.filter(t => t.id !== taskId).map(task => `<option value="${task.id}">${task.name}</option>`);
                    const noneOption = `<option value="">Ninguna</option>`;
                    select.innerHTML = noneOption + options.join('');
                    
                    const currentPredecessorId = editableCell.dataset.predecessorId;
                    select.value = currentPredecessorId;
                    
                    select.className = 'w-full text-gray-900';
                    editableCell.appendChild(select);
                    select.focus();
                    
                    select.addEventListener('change', function() {
                        updateTaskInFirestore(taskId, field, select.value);
                    });
                    select.addEventListener('blur', function() {
                        editableCell.textContent = originalText;
                    });

                } else {
                    const input = document.createElement('input');
                    input.type = (field === 'duration') ? 'number' : 'text';
                    input.value = (field === 'duration') ? parseInt(originalText.replace(' días', '')) : originalText;
                    input.className = 'w-full text-gray-900';
                    editableCell.appendChild(input);
                    input.focus();

                    const commitEdit = () => {
                        const newValue = input.value.trim();
                        let displayValue = newValue;
                        let valueToSave = newValue;

                        if (field === 'duration') {
                            if (isNaN(parseInt(newValue)) || parseInt(newValue) <= 0) {
                                showMessage("La duración debe ser un número positivo.");
                                editableCell.textContent = originalText;
                                return;
                            }
                            displayValue = `${newValue} días`;
                            valueToSave = parseInt(newValue);
                        }

                        if (newValue !== originalText && newValue !== '') {
                            updateTaskInFirestore(taskId, field, valueToSave);
                        } else {
                            editableCell.textContent = originalText;
                        }
                    };

                    input.addEventListener('keydown', function(event) {
                        if (event.key === 'Enter') {
                            commitEdit();
                        } else if (event.key === 'Escape') {
                            editableCell.textContent = originalText;
                        }
                    });

                    input.addEventListener('blur', commitEdit);
                }
            }
        });
        
        // Función para mostrar el cuadro de mensaje personalizado
        function showMessage(text) {
            messageText.textContent = text;
            messageBox.classList.remove('hidden');
        }

        // Cerrar el cuadro de mensaje
        closeMessageBtn.addEventListener('click', () => {
            messageBox.classList.add('hidden');
        });
    </script>
</body>
</html>
